<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Offer Creator - Circles Tools</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                margin: 0;
                font-family: "Inter", Helvetica, Arial, sans-serif;
                background: #ffffff;
                color: #333;
                line-height: 1.3;
            }
            header {
                background: #5c49e4;
                color: #fff;
                padding: 20px;
                text-align: center;
            }
            h1 {
                margin: 0;
                font-weight: 600;
                font-size: 1.5rem;
            }
            p {
                margin: 0.5rem 0 0;
                font-weight: 400;
            }
            .container {
                max-width: 800px;
                margin: 40px auto;
                padding: 0 20px;
            }
            .form-group {
                margin-bottom: 20px;
            }
            label {
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
            }
            input, select {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-family: inherit;
                box-sizing: border-box;
            }
            button {
                background: #5c49e4;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 600;
                margin-right: 10px;
                margin-bottom: 10px;
            }
            button:hover {
                background: #4a3bc4;
            }
            button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
            .status {
                margin-top: 20px;
                padding: 10px;
                border-radius: 4px;
                display: none;
            }
            .status.success {
                background: #e6ffe6;
                color: #006600;
                display: block;
            }
            .status.error {
                background: #ffe6e6;
                color: #cc0000;
                display: block;
            }
            .status.info {
                background: #e6f3ff;
                color: #0066cc;
                display: block;
            }
            .connection-status {
                margin: 20px 0;
                padding: 10px;
                border-radius: 4px;
                background: #f0f0f0;
            }
            .connection-status.connected {
                background: #e6ffe6;
                color: #006600;
            }
            .connection-status.disconnected {
                background: #ffe6e6;
                color: #cc0000;
            }
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            .stat-card {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                border-left: 4px solid #5c49e4;
            }
            .stat-label {
                font-weight: 600;
                margin-bottom: 5px;
                color: #666;
                font-size: 0.9rem;
            }
            .stat-value {
                font-size: 1.2rem;
                font-weight: 600;
            }
            .wizard-step {
                background: #f8f9fa;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 20px;
            }
            .wizard-step h3 {
                margin-top: 0;
                color: #5c49e4;
            }
            .wizard-step.disabled {
                opacity: 0.6;
                pointer-events: none;
            }
            .note {
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                color: #856404;
                padding: 10px;
                border-radius: 4px;
                margin-bottom: 15px;
                font-size: 0.9rem;
            }
            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 2px solid #f3f3f3;
                border-radius: 50%;
                border-top: 2px solid #5c49e4;
                animation: spin 1s linear infinite;
                vertical-align: middle;
                margin-left: 10px;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    </head>
    <body>
        <header>
            <h1>Offer Creator</h1>
            <p>Create new offers for the Circles ecosystem</p>
        </header>

        <div class="container">
            <div id="connectionStatus" class="connection-status disconnected">
                Not connected to MetaMask
            </div>

            <!-- Current Offer Stats -->
            <div id="statsSection">
                <h2>Current Offer Status</h2>
                <div class="stats-grid" id="statsGrid">
                    <!-- Stats will be populated here -->
                </div>
            </div>

            <!-- Admin Check -->
            <div id="adminCheckSection" class="wizard-step disabled">
                <h3>Step 1: Admin Verification</h3>
                <p>Verifying that you are the admin of this offer contract...</p>
                <div id="adminStatus"></div>
            </div>

            <!-- Next Offer Check -->
            <div id="nextOfferCheckSection" class="wizard-step disabled">
                <h3>Step 2: Next Offer Status</h3>
                <div id="nextOfferStatus"></div>
            </div>

            <!-- Create Offer Form -->
            <div id="createOfferSection" class="wizard-step disabled">
                <h3>Step 3: Create New Offer</h3>
                <form id="createOfferForm">
                    <div class="form-group">
                        <label for="tokenPrice">Token Price (CRC per 1 GNO):</label>
                        <div class="note">
                            This is the discounted price. Enter the amount of CRC (in 18 decimals) that buys 1 GNO.
                        </div>
                        <input type="text" id="tokenPrice" placeholder="e.g., 1000000000000000000 (for 1 CRC per GNO)" required>
                    </div>

                    <div class="form-group">
                        <label for="offerLimit">Offer Limit (CRC):</label>
                        <input type="text" id="offerLimit" value="250000000000000000000" required>
                        <small>Default: 250 CRC</small>
                    </div>

                    <div class="form-group">
                        <label>Accepted CRC Tokens:</label>
                        <div class="note">
                            The list of accepted CRC tokens will be loaded automatically from acceptedCRCs.txt
                        </div>
                        <div id="acceptedCRCsStatus">Loading accepted CRCs...</div>
                    </div>

                    <button type="submit" id="createOfferBtn" disabled>Create Offer</button>
                </form>
            </div>

            <div id="status" class="status"></div>
        </div>

        <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
        <script>
            // Contract configuration
            const OFFER_CONTRACT_ADDRESS = '0x76A42aEbb2c54d7E259b1C7e4Eb0Cadf5897a7de';

            // Contract ABI
            const OFFER_CONTRACT_ABI = [
                {"inputs":[{"internalType":"address","name":"admin","type":"address"},{"internalType":"address","name":"offerToken","type":"address"},{"internalType":"uint256","name":"offersStart","type":"uint256"},{"internalType":"uint256","name":"offerDuration","type":"uint256"},{"internalType":"bool","name":"enableSoftLock","type":"bool"},{"internalType":"string","name":"offerName","type":"string"},{"internalType":"string","name":"orgName","type":"string"}],"stateMutability":"nonpayable","type":"constructor"},
                {"inputs":[],"name":"NextOfferTokensAreAlreadyDeposited","type":"error"},
                {"inputs":[],"name":"OnlyAdmin","type":"error"},
                {"inputs":[],"name":"OnlyHub","type":"error"},
                {"inputs":[],"name":"SoftLock","type":"error"},
                {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"admin","type":"address"},{"indexed":true,"internalType":"address","name":"accountWeightProvider","type":"address"},{"indexed":true,"internalType":"address","name":"offerToken","type":"address"},{"indexed":false,"internalType":"uint256","name":"offersStart","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"offerDuration","type":"uint256"},{"indexed":false,"internalType":"bool","name":"softLockEnabled","type":"bool"}],"name":"CycleConfiguration","type":"event"},
                {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"nextOffer","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenPriceInCRC","type":"uint256"},{"indexed":true,"internalType":"uint256","name":"offerLimitInCRC","type":"uint256"},{"indexed":false,"internalType":"address[]","name":"acceptedCRC","type":"address[]"}],"name":"NextOfferCreated","type":"event"},
                {"inputs":[],"name":"ADMIN","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
                {"inputs":[],"name":"OFFERS_START","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
                {"inputs":[],"name":"OFFER_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
                {"inputs":[{"internalType":"uint256","name":"tokenPriceInCRC","type":"uint256"},{"internalType":"uint256","name":"offerLimitInCRC","type":"uint256"},{"internalType":"address[]","name":"_acceptedCRC","type":"address[]"}],"name":"createNextOffer","outputs":[{"internalType":"address","name":"nextOffer","type":"address"}],"stateMutability":"nonpayable","type":"function"},
                {"inputs":[],"name":"currentOffer","outputs":[{"internalType":"contract IERC20TokenOffer","name":"offer","type":"address"}],"stateMutability":"view","type":"function"},
                {"inputs":[],"name":"currentOfferId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
                {"inputs":[],"name":"getClaimantCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
                {"inputs":[],"name":"getTotalEligibleAccounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
                {"inputs":[],"name":"isOfferAvailable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
                {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"offers","outputs":[{"internalType":"contract IERC20TokenOffer","name":"","type":"address"}],"stateMutability":"view","type":"function"}
            ];

            let provider;
            let signer;
            let contract;
            let acceptedCRCs = [];

            // Wait for ethers to be available
            window.addEventListener('load', async function() {
                if (typeof ethers === 'undefined') {
                    console.error('ethers.js failed to load');
                    return;
                }

                await checkConnection();
                await loadAcceptedCRCs();
                await loadOfferStats();

                // Handle account changes
                if (window.ethereum) {
                    window.ethereum.on('accountsChanged', function (accounts) {
                        checkConnection();
                    });
                }
            });

            async function checkConnection() {
                const connectionStatus = document.getElementById('connectionStatus');

                if (typeof window.ethereum === 'undefined') {
                    connectionStatus.textContent = 'MetaMask is not installed';
                    connectionStatus.className = 'connection-status disconnected';
                    return false;
                }

                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const account = accounts[0];
                    connectionStatus.textContent = `Connected: ${account}`;
                    connectionStatus.className = 'connection-status connected';

                    // Initialize provider and contract
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    contract = new ethers.Contract(OFFER_CONTRACT_ADDRESS, OFFER_CONTRACT_ABI, provider);

                    // Check admin status
                    await checkAdminStatus();

                    return true;
                } catch (error) {
                    connectionStatus.textContent = 'Failed to connect to MetaMask';
                    connectionStatus.className = 'connection-status disconnected';
                    return false;
                }
            }

            async function loadAcceptedCRCs() {
                const statusElement = document.getElementById('acceptedCRCsStatus');

                try {
                    const response = await fetch('acceptedCRCs.txt');
                    if (!response.ok) {
                        throw new Error(`Failed to load acceptedCRCs.txt: ${response.status}`);
                    }

                    const text = await response.text();
                    // Parse the array-like string format
                    const addressesMatch = text.match(/\[(.*)\]/s);
                    if (addressesMatch) {
                        const addressesString = addressesMatch[1];
                        acceptedCRCs = addressesString
                            .split(',')
                            .map(addr => addr.trim().replace(/['"]/g, ''))
                            .filter(addr => addr.startsWith('0x'));
                    }

                    statusElement.textContent = `Loaded ${acceptedCRCs.length} accepted CRC tokens`;
                    statusElement.className = 'status success';

                    // Enable the create offer button if other conditions are met
                    updateCreateOfferButton();

                } catch (error) {
                    console.error('Error loading accepted CRCs:', error);
                    statusElement.textContent = `Error loading accepted CRCs: ${error.message}`;
                    statusElement.className = 'status error';
                }
            }

            async function loadOfferStats() {
                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = '<div>Loading stats...</div>';

                try {
                    if (!contract) {
                        provider = new ethers.providers.JsonRpcProvider('https://rpc.gnosischain.com');
                        contract = new ethers.Contract(OFFER_CONTRACT_ADDRESS, OFFER_CONTRACT_ABI, provider);
                    }

                    // Get basic stats
                    const [
                        offersStart,
                        offerDuration,
                        totalEligibleAccounts,
                        claimantCount,
                        isOfferAvailable,
                        currentOffer,
                        currentOfferId
                    ] = await Promise.all([
                        contract.OFFERS_START(),
                        contract.OFFER_DURATION(),
                        contract.getTotalEligibleAccounts(),
                        contract.getClaimantCount(),
                        contract.isOfferAvailable(),
                        contract.currentOffer(),
                        contract.currentOfferId()
                    ]);

                    // Calculate offer times
                    const startTime = new Date(offersStart.toNumber() * 1000);
                    const endTime = new Date((offersStart.toNumber() + offerDuration.toNumber()) * 1000);

                    // Create stats cards
                    const stats = [
                        {
                            label: 'Current Offer Start',
                            value: startTime.toLocaleString()
                        },
                        {
                            label: 'Current Offer End',
                            value: endTime.toLocaleString()
                        },
                        {
                            label: 'Total Eligible Accounts',
                            value: totalEligibleAccounts.toString()
                        },
                        {
                            label: 'Claimant Count',
                            value: claimantCount.toString()
                        },
                        {
                            label: 'Offer Available',
                            value: isOfferAvailable ? 'Yes' : 'No'
                        },
                        {
                            label: 'Current Offer Address',
                            value: currentOffer === ethers.constants.AddressZero ? 'None' : currentOffer
                        },
                        {
                            label: 'Current Offer ID',
                            value: currentOfferId.toString()
                        }
                    ];

                    statsGrid.innerHTML = stats.map(stat => `
                        <div class="stat-card">
                            <div class="stat-label">${stat.label}</div>
                            <div class="stat-value">${stat.value}</div>
                        </div>
                    `).join('');

                } catch (error) {
                    console.error('Error loading offer stats:', error);
                    statsGrid.innerHTML = `<div class="status error">Error loading stats: ${error.message}</div>`;
                }
            }

            async function checkAdminStatus() {
                const adminCheckSection = document.getElementById('adminCheckSection');
                const adminStatus = document.getElementById('adminStatus');

                adminCheckSection.classList.remove('disabled');
                adminStatus.innerHTML = 'Checking admin status... <div class="loading"></div>';

                try {
                    if (!contract) return;

                    const adminAddress = await contract.ADMIN();
                    const connectedAddress = await signer.getAddress();

                    const isAdmin = adminAddress.toLowerCase() === connectedAddress.toLowerCase();

                    if (isAdmin) {
                        adminStatus.innerHTML = `<div class="status success">✓ You are the admin of this contract</div>`;
                        // Enable next step
                        await checkNextOfferStatus();
                    } else {
                        adminStatus.innerHTML = `
                            <div class="status error">✗ You are not the admin of this contract</div>
                            <p>Admin address: ${adminAddress}</p>
                            <p>Your address: ${connectedAddress}</p>
                        `;
                    }

                } catch (error) {
                    console.error('Error checking admin status:', error);
                    adminStatus.innerHTML = `<div class="status error">Error checking admin status: ${error.message}</div>`;
                }
            }

            async function checkNextOfferStatus() {
                const nextOfferCheckSection = document.getElementById('nextOfferCheckSection');
                const nextOfferStatus = document.getElementById('nextOfferStatus');

                nextOfferCheckSection.classList.remove('disabled');
                nextOfferStatus.innerHTML = 'Checking next offer status... <div class="loading"></div>';

                try {
                    const currentOfferId = await contract.currentOfferId();
                    const nextOfferId = currentOfferId.add(1);

                    // Check if next offer exists
                    const nextOfferAddress = await contract.offers(nextOfferId);
                    const nextOfferExists = nextOfferAddress !== ethers.constants.AddressZero;

                    if (nextOfferExists) {
                        nextOfferStatus.innerHTML = `
                            <div class="status info">Next offer already exists at address: ${nextOfferAddress}</div>
                            <p>You can proceed to deposit tokens or withdraw this existing offer if needed.</p>
                        `;
                        // Don't enable create offer form since offer already exists
                    } else {
                        nextOfferStatus.innerHTML = `<div class="status success">No next offer exists. You can create a new one.</div>`;
                        // Enable create offer form
                        document.getElementById('createOfferSection').classList.remove('disabled');
                        updateCreateOfferButton();
                    }

                } catch (error) {
                    console.error('Error checking next offer status:', error);
                    nextOfferStatus.innerHTML = `<div class="status error">Error checking next offer status: ${error.message}</div>`;
                }
            }

            function updateCreateOfferButton() {
                const createOfferBtn = document.getElementById('createOfferBtn');
                const hasAcceptedCRCs = acceptedCRCs.length > 0;
                const formEnabled = !document.getElementById('createOfferSection').classList.contains('disabled');

                createOfferBtn.disabled = !hasAcceptedCRCs || !formEnabled;
            }

            // Form submission handler
            document.getElementById('createOfferForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const status = document.getElementById('status');
                const tokenPrice = document.getElementById('tokenPrice').value;
                const offerLimit = document.getElementById('offerLimit').value;

                if (!tokenPrice || !offerLimit) {
                    status.textContent = 'Please fill in all required fields';
                    status.className = 'status error';
                    return;
                }

                if (acceptedCRCs.length === 0) {
                    status.textContent = 'Accepted CRCs not loaded yet';
                    status.className = 'status error';
                    return;
                }

                try {
                    status.textContent = 'Creating offer... This may take some time if you are using a Safe wallet.';
                    status.className = 'status info';

                    // Convert inputs to proper format
                    const tokenPriceBN = ethers.BigNumber.from(tokenPrice);
                    const offerLimitBN = ethers.BigNumber.from(offerLimit);

                    // Create the offer
                    const contractWithSigner = contract.connect(signer);
                    const tx = await contractWithSigner.createNextOffer(
                        tokenPriceBN,
                        offerLimitBN,
                        acceptedCRCs
                    );

                    status.textContent = 'Transaction sent! Waiting for confirmation...';
                    status.className = 'status info';

                    const receipt = await tx.wait();

                    // Find the NextOfferCreated event
                    const nextOfferCreatedEvent = receipt.events?.find(e => e.event === 'NextOfferCreated');

                    if (nextOfferCreatedEvent) {
                        const nextOfferAddress = nextOfferCreatedEvent.args.nextOffer;
                        status.innerHTML = `
                            <div class="status success">
                                ✓ Offer created successfully!<br>
                                Next offer address: ${nextOfferAddress}<br>
                                Transaction hash: ${receipt.transactionHash}
                            </div>
                        `;

                        // Reload stats and check next offer status
                        await loadOfferStats();
                        await checkNextOfferStatus();
                    } else {
                        status.textContent = 'Transaction successful but no NextOfferCreated event found';
                        status.className = 'status success';
                    }

                } catch (error) {
                    console.error('Error creating offer:', error);
                    let errorMessage = error.message;

                    // Handle common errors
                    if (errorMessage.includes('user rejected')) {
                        errorMessage = 'Transaction was rejected by user';
                    } else if (errorMessage.includes('OnlyAdmin')) {
                        errorMessage = 'Only the admin can create offers';
                    } else if (errorMessage.includes('NextOfferTokensAreAlreadyDeposited')) {
                        errorMessage = 'Next offer tokens are already deposited';
                    }

                    status.textContent = `Error creating offer: ${errorMessage}`;
                    status.className = 'status error';
                }
            });
        </script>
    </body>
</html>
